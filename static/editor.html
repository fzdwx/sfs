<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êñá‰ª∂ÁºñËæëÂô®</title>
    <link rel="stylesheet" href="/static/vditor/index.css" />
    <script src="/static/vditor/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .header h1 {
            font-size: 18px;
            color: #333;
        }
        .filename {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }
        .buttons {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #545b62;
        }
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        .file-tree {
            padding: 10px 0;
        }
        .tree-item {
            padding: 6px 15px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            user-select: none;
        }
        .tree-item:hover {
            background: #f0f0f0;
        }
        .tree-item.active {
            background: #e7f3ff;
            color: #007bff;
        }
        .tree-item.directory {
            font-weight: 500;
        }
        .tree-item .icon {
            margin-right: 6px;
            width: 16px;
            display: inline-block;
        }
        .tree-item .toggle {
            margin-right: 4px;
            width: 12px;
            display: inline-block;
            text-align: center;
        }
        .tree-item.collapsed .toggle::before {
            content: '‚ñ∂';
        }
        .tree-item.expanded .toggle::before {
            content: '‚ñº';
        }
        .tree-item.file .toggle {
            opacity: 0;
        }
        .tree-children {
            padding-left: 20px;
        }
        .tree-children.hidden {
            display: none;
        }
        .editor-container {
            flex: 1;
            display: flex;
            padding: 20px;
            overflow: hidden;
        }
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #vditor {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            display: none;
            overflow: auto;
        }
        #vditor.active {
            display: block;
        }
        #plainTextEditor {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            display: none;
            box-sizing: border-box;
            overflow: auto;
        }
        #plainTextEditor:focus {
            border-color: #007bff;
        }
        #mediaViewer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        textarea:focus {
            border-color: #007bff;
        }
        .message {
            padding: 10px 20px;
            display: none;
            text-align: center;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div id="message" class="message"></div>

    <div class="header">
        <div>
            <span class="filename" id="filename">Êñ∞Âª∫Êñá‰ª∂</span>
        </div>
        <div class="buttons">
            <button onclick="saveFile()">‰øùÂ≠ò</button>
            <button class="secondary" onclick="goBack()">ËøîÂõû</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">Êñá‰ª∂ÂàóË°®</div>
            <div class="file-tree" id="fileTree"></div>
        </div>

        <div class="editor-container">
            <div class="editor-panel">
                <div id="vditor"></div>
                <textarea id="plainTextEditor"></textarea>
                <div id="mediaViewer">
                    <img id="imageViewer" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;" />
                    <video id="videoViewer" controls style="max-width: 100%; max-height: 100%; display: none;"></video>
                    <audio id="audioViewer" controls style="width: 80%; display: none;"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPath = '';
        let currentDir = '';
        let isNewFile = false;
        let fileTreeData = {};
        let vditor = null;

        // Êñá‰ª∂ÂõæÊ†áÊò†Â∞ÑÁ≥ªÁªü
        const fileIcons = {
            // ÊñáÊ°£
            'txt': 'üìù',
            'doc': 'üìò',
            'docx': 'üìò',
            'pdf': 'üìï',
            'md': 'üìì',

            // ÂõæÁâá
            'jpg': 'üñºÔ∏è',
            'jpeg': 'üñºÔ∏è',
            'png': 'üñºÔ∏è',
            'gif': 'üñºÔ∏è',
            'bmp': 'üñºÔ∏è',
            'svg': 'üñºÔ∏è',
            'webp': 'üñºÔ∏è',

            // ËßÜÈ¢ë
            'mp4': 'üé¨',
            'avi': 'üé¨',
            'mkv': 'üé¨',
            'mov': 'üé¨',

            // Èü≥È¢ë
            'mp3': 'üéµ',
            'wav': 'üéµ',
            'flac': 'üéµ',

            // ÂéãÁº©ÂåÖ
            'zip': 'üì¶',
            'rar': 'üì¶',
            'tar': 'üì¶',
            'gz': 'üì¶',
            '7z': 'üì¶',

            // ‰ª£Á†Å
            'js': 'üìú',
            'ts': 'üìú',
            'py': 'üêç',
            'go': 'üî∑',
            'java': '‚òï',
            'cpp': '‚öôÔ∏è',
            'c': '‚öôÔ∏è',
            'html': 'üåê',
            'css': 'üé®',
            'json': 'üìã',
            'xml': 'üìã',
            'yaml': 'üìã',
            'yml': 'üìã',

            // ÂèØÊâßË°åÊñá‰ª∂
            'exe': '‚öôÔ∏è',
            'sh': '‚öôÔ∏è',
            'bat': '‚öôÔ∏è',

            // ÈªòËÆ§
            'default': 'üìÑ'
        };

        function getFileIcon(filename, isDir) {
            if (isDir) return 'üìÅ';

            const parts = filename.split('.');
            if (parts.length === 1) {
                return '‚ùì';
            }

            const ext = parts.pop().toLowerCase();
            return fileIcons[ext] || fileIcons['default'];
        }

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const filePath = params.get('file');
            currentDir = params.get('dir') || '';

            loadFileTree();

            // Ê£ÄÊü•ÊòØÂê¶ÊòØMarkdownÊñá‰ª∂
            const isMarkdown = filePath && filePath.toLowerCase().endsWith('.md');

            if (isMarkdown) {
                // Âè™ÂØπ.mdÊñá‰ª∂ÂàùÂßãÂåñVditorÁºñËæëÂô®
                // ÂÖàÊòæÁ§∫vditorÂÆπÂô®ÔºåËÆ©VditorËÉΩÊ≠£Á°ÆËÆ°ÁÆóÂ∞∫ÂØ∏
                document.getElementById('vditor').classList.add('active');

                vditor = new Vditor('vditor', {
                    height: '100%',
                    mode: 'ir', // ‰ΩøÁî®ÂàÜÂ±èÈ¢ÑËßàÊ®°ÂºèÔºàsplit viewÔºâ
                    placeholder: 'ÂºÄÂßãÁºñËæë...',
                    theme: 'classic',
                    preview: {
                        delay: 300,
                    },
                    toolbar: [
                        'emoji',
                        'headings',
                        'bold',
                        'italic',
                        'strike',
                        'link',
                        '|',
                        'list',
                        'ordered-list',
                        'check',
                        'outdent',
                        'indent',
                        '|',
                        'quote',
                        'line',
                        'code',
                        'inline-code',
                        'insert-before',
                        'insert-after',
                        '|',
                        'upload',
                        'table',
                        '|',
                        'undo',
                        'redo',
                        '|',
                        'fullscreen',
                        'edit-mode',
                        {
                            name: 'more',
                            toolbar: [
                                'both',
                                'code-theme',
                                'content-theme',
                                'export',
                                'outline',
                                'preview',
                                'devtools',
                                'info',
                                'help',
                            ],
                        }],
                    upload: {
                        url: '/api/upload',
                        fieldName: 'files',
                        format(files, responseText) {
                            const response = JSON.parse(responseText);
                            if (response.success) {
                                // ‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑpathÔºàÂõæÁâá‰ºöËá™Âä®‰øùÂ≠òÂà∞ /assert/ ÁõÆÂΩïÔºâ
                                const imagePath = response.path || files[0].name;
                                const imageUrl = '/files/' + encodeURIComponent(imagePath);
                                return JSON.stringify({
                                    msg: '',
                                    code: 0,
                                    data: {
                                        errFiles: [],
                                        succMap: {
                                            [files[0].name]: imageUrl
                                        }
                                    }
                                });
                            } else {
                                return JSON.stringify({
                                    msg: response.error || '‰∏ä‰º†Â§±Ë¥•',
                                    code: 1,
                                    data: {
                                        errFiles: [files[0].name],
                                        succMap: {}
                                    }
                                });
                            }
                        }
                    },
                    after: () => {
                        // VditorÂàùÂßãÂåñÂÆåÊàêÂêéÂä†ËΩΩÊñá‰ª∂
                        if (filePath) {
                            currentPath = filePath;
                            loadFile(filePath);
                        } else {
                            isNewFile = true;
                            document.getElementById('filename').textContent = 'Êñ∞Âª∫Êñá‰ª∂';
                        }
                    }
                });
            } else {
                // ÈùûMarkdownÊñá‰ª∂ÔºåÁõ¥Êé•Âä†ËΩΩ
                if (filePath) {
                    currentPath = filePath;
                    loadFile(filePath);
                } else {
                    isNewFile = true;
                    document.getElementById('filename').textContent = 'Êñ∞Âª∫Êñá‰ª∂';
                }
            }
        };

        function loadFileTree(path = '') {
            fetch('/api/files?path=' + encodeURIComponent(path))
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (path === '') {
                            renderFileTree(data.files || []);
                        }
                    }
                })
                .catch(err => {
                    console.error('Âä†ËΩΩÊñá‰ª∂Ê†ëÂ§±Ë¥•:', err);
                });
        }

        function renderFileTree(files, container = null, level = 0) {
            if (!container) {
                container = document.getElementById('fileTree');
                container.textContent = '';
            }

            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'tree-item ' + (file.isDir ? 'directory collapsed' : 'file');
                item.style.paddingLeft = (15 + level * 20) + 'px';

                if (file.isDir) {
                    const toggle = document.createElement('span');
                    toggle.className = 'toggle';
                    item.appendChild(toggle);
                }

                const icon = document.createElement('span');
                icon.className = 'icon';
                icon.textContent = getFileIcon(file.name, file.isDir);
                item.appendChild(icon);

                const name = document.createElement('span');
                name.textContent = file.name;
                item.appendChild(name);

                if (file.path === currentPath) {
                    item.classList.add('active');
                }

                if (file.isDir) {
                    item.onclick = function(e) {
                        e.stopPropagation();
                        toggleDirectory(item, file.path, level);
                    };
                } else {
                    item.onclick = function(e) {
                        e.stopPropagation();
                        openFile(file.path, file.size);
                    };
                }

                container.appendChild(item);

                if (file.isDir) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'tree-children hidden';
                    childrenContainer.dataset.path = file.path;
                    container.appendChild(childrenContainer);
                }
            });
        }

        function toggleDirectory(item, path, level) {
            const isCollapsed = item.classList.contains('collapsed');
            const childrenContainer = item.nextElementSibling;

            if (isCollapsed) {
                item.classList.remove('collapsed');
                item.classList.add('expanded');

                if (childrenContainer.children.length === 0) {
                    fetch('/api/files?path=' + encodeURIComponent(path))
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                renderFileTree(data.files || [], childrenContainer, level + 1);
                                childrenContainer.classList.remove('hidden');
                            }
                        })
                        .catch(err => {
                            console.error('Âä†ËΩΩÁõÆÂΩïÂ§±Ë¥•:', err);
                        });
                } else {
                    childrenContainer.classList.remove('hidden');
                }
            } else {
                item.classList.remove('expanded');
                item.classList.add('collapsed');
                childrenContainer.classList.add('hidden');
            }
        }

        function openFile(filePath, fileSize) {
            const ONE_MB = 1024 * 1024;

            if (fileSize && fileSize > ONE_MB) {
                const sizeMB = (fileSize / ONE_MB).toFixed(2);
                const confirmed = confirm(
                    'ËØ•Êñá‰ª∂Â§ßÂ∞è‰∏∫ ' + sizeMB + ' MBÔºåÂèØËÉΩ‰ºöÂØºËá¥ÊµèËßàÂô®Âç°È°ø„ÄÇ\n\nÊòØÂê¶ÁªßÁª≠ÊâìÂºÄÔºü'
                );
                if (!confirmed) {
                    return;
                }
            }

            const urlParams = new URLSearchParams();
            urlParams.set('file', filePath);
            urlParams.set('dir', currentDir);
            window.location.href = '/editor?' + urlParams.toString();
        }

        function loadFile(filePath) {
            document.getElementById('filename').textContent = filePath;

            // Ê£ÄÊµãÊñá‰ª∂Á±ªÂûã
            const ext = filePath.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            const videoExts = ['mp4', 'webm', 'ogg', 'avi', 'mov', 'mkv'];
            const audioExts = ['mp3', 'wav', 'ogg', 'flac', 'm4a'];

            // Ëé∑ÂèñÊâÄÊúâÁºñËæëÂô®ÂÖÉÁ¥†
            const vditorEl = document.getElementById('vditor');
            const plainEditor = document.getElementById('plainTextEditor');
            const mediaViewer = document.getElementById('mediaViewer');
            const imageViewer = document.getElementById('imageViewer');
            const videoViewer = document.getElementById('videoViewer');
            const audioViewer = document.getElementById('audioViewer');

            // ÈöêËóèÊâÄÊúâÁºñËæëÂô®
            vditorEl.classList.remove('active');
            plainEditor.style.display = 'none';
            mediaViewer.style.display = 'none';
            imageViewer.style.display = 'none';
            videoViewer.style.display = 'none';
            audioViewer.style.display = 'none';

            if (imageExts.includes(ext)) {
                // ÊòæÁ§∫ÂõæÁâáÊü•ÁúãÂô®
                mediaViewer.style.display = 'flex';
                imageViewer.style.display = 'block';
                imageViewer.src = '/files/' + encodeURIComponent(filePath);
            } else if (videoExts.includes(ext)) {
                // ÊòæÁ§∫ËßÜÈ¢ëÊí≠ÊîæÂô®
                mediaViewer.style.display = 'flex';
                videoViewer.style.display = 'block';
                videoViewer.src = '/files/' + encodeURIComponent(filePath);
            } else if (audioExts.includes(ext)) {
                // ÊòæÁ§∫Èü≥È¢ëÊí≠ÊîæÂô®
                mediaViewer.style.display = 'flex';
                audioViewer.style.display = 'block';
                audioViewer.src = '/files/' + encodeURIComponent(filePath);
            } else if (ext === 'md') {
                // MarkdownÊñá‰ª∂ - ‰ΩøÁî®VditorÁºñËæëÂô®
                vditorEl.classList.add('active');

                fetch('/api/read?path=' + encodeURIComponent(filePath))
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            if (vditor) {
                                vditor.setValue(data.content);
                            }
                        } else {
                            showMessage('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: ' + data.error, 'error');
                        }
                    })
                    .catch(err => {
                        showMessage('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: ' + err.message, 'error');
                    });
            } else {
                // ÂÖ∂‰ªñÊñáÊú¨Êñá‰ª∂ - ‰ΩøÁî®ÊôÆÈÄöÁºñËæëÂô®
                plainEditor.style.display = 'block';

                fetch('/api/read?path=' + encodeURIComponent(filePath))
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            plainEditor.value = data.content;
                        } else {
                            showMessage('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: ' + data.error, 'error');
                        }
                    })
                    .catch(err => {
                        showMessage('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•: ' + err.message, 'error');
                    });
            }
        }

        function saveFile() {
            let path = currentPath;

            if (isNewFile || !path) {
                const filename = prompt('ËØ∑ËæìÂÖ•Êñá‰ª∂Âêç:');
                if (!filename) return;
                path = currentDir ? currentDir + '/' + filename : filename;
            }

            // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãËé∑ÂèñÂÜÖÂÆπ
            let content = '';
            const ext = path.split('.').pop().toLowerCase();
            if (ext === 'md' && vditor) {
                // MarkdownÊñá‰ª∂‰ΩøÁî®Vditor
                content = vditor.getValue();
            } else {
                // ÂÖ∂‰ªñÊñáÊú¨Êñá‰ª∂‰ΩøÁî®ÊôÆÈÄöÁºñËæëÂô®
                content = document.getElementById('plainTextEditor').value;
            }

            fetch('/api/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: path,
                    content: content
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showMessage('‰øùÂ≠òÊàêÂäü', 'success');
                    if (isNewFile) {
                        isNewFile = false;
                        currentPath = path;
                        document.getElementById('filename').textContent = path;
                        loadFileTree();
                    }
                } else {
                    showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + data.error, 'error');
                }
            })
            .catch(err => {
                showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + err.message, 'error');
            });
        }

        function goBack() {
            window.location.href = '/?path=' + encodeURIComponent(currentDir);
        }

        function showMessage(msg, type) {
            const message = document.getElementById('message');
            message.textContent = msg;
            message.className = 'message ' + type;
            message.style.display = 'block';

            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
        });
    </script>
</body>
</html>
